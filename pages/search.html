<div x-data="search($router)">

    <!-- Body -->
    <div class="body">

        <!-- Header -->
        <header class="primary-container hide-print">
            <nav>
                <a href="javascript:void(0);" @click="logout">Déconnexion</a>
                <h5 class="max center-align">Kontabl</h5>
                <div class="space"></div>
                <div class="space"></div>
                <div class="space"></div>
                <div class="space"></div>
            </nav>
        </header>

        <!-- Main -->
        <div class="main">

            <!-- Welcome Title -->
            <div class="medium no-padding left-align top-align hide-print" style="margin-bottom: 12px;">
                <h4>Ravi de vous revoir,</h4>
            </div>

            <div class="flex">
                <article class="no-elevate hide-print">
                    <!-- Slider Buttons Section in a table -->
                    <div class="tabs">
                        <a href="javascript:void(0);" :class="selectedTab == 'tr' ? 'active' : ''"
                            @click="openTab('tr')">
                            <img class="icon" src="/img/tresorerie.svg">
                            <span>Trésorerie</span>
                        </a>
                        <a href="javascript:void(0);" :class="selectedTab == 're' ? 'active' : ''"
                            @click="openTab('re')">
                            <img class="icon" src="/img/remise.svg">
                            <span>Remises</span>
                        </a>
                        <a href="javascript:void(0);" :class="selectedTab == 'im' ? 'active' : ''"
                            @click="openTab('im')">
                            <img class="icon" src="/img/unpaid.svg">
                            <span>Impayés</span>
                        </a>
                    </div>
                    <!-- Section avec tous les inputs affichés par défaut des sélections -->
                    <div class="field suffix border" x-show="userType == 'productowner' && selectedTab == 'tr'"
                        x-transition x-transition.duration.300>
                        <select x-model="siren">
                            <option value="" selected>Tous les numéros de Siren</option>
                            <template x-for="siren in sirenNumbers" :key="siren">
                                <option :value="siren" x-text="siren"></option>
                            </template>
                        </select>
                        <a class="loader" x-show="sirenNumbers.length == 0" x-transition x-transition.duration.300></a>
                        <i x-show="sirenNumbers.length != 0">arrow_drop_down</i>
                    </div>
                    <div class="field label suffix border" x-show="userType == 'productowner' && selectedTab == 'tr'"
                        x-transition x-transition.duration.300>
                        <input type="text" id="socialName" name="socialName" x-model="socialName">
                        <label>Raison sociale</label>
                    </div>
                    <div class="field label prefix border" x-show="selectedTab == 'tr'" x-transition
                        x-transition.duration.300 @click="document.getElementById('date').showPicker()">
                        <i>today</i>
                        <input type="date" id="date" name="date" x-model="date">
                        <label class="active">Date</label>
                    </div>
                    <div class="field label prefix border" x-show="selectedTab != 'tr'" x-transition
                        x-transition.duration.300 @click="document.getElementById('dateBefore').showPicker()">
                        <i>today</i>
                        <input type="date" id="dateBefore" name="dateBefore" x-model="dateBefore">
                        <label class="active">Date avant le</label>
                    </div>
                    <div class="field label prefix border" x-show="selectedTab != 'tr'" x-transition
                        x-transition.duration.300 @click="document.getElementById('dateAfter').showPicker()">
                        <i>today</i>
                        <input type="date" id="dateAfter" name="dateAfter" x-model="dateAfter">
                        <label class="active">Date après le</label>
                    </div>
                    <div class="field label border" x-show="selectedTab == 'im'" x-transition x-transition.duration.300>
                        <input type="tel" id="dossierUnpaid" name="dossierUnpaid">
                        <label>N° dossier impayé</label>
                    </div>
                    <!-- Search Button -->
                    <button class="responsive no-margin" @click="search">Rechercher</button>
                </article>

                <article class="no-elevate">
                    <div x-show="loading" class="middle-align center-align" style="height: 300px;">
                        <a class="loader"></a>
                    </div>

                    <div x-show="!loading">
                        <div x-show="selectedTab == 'tr'">
                            <template x-for="(item, i) in results" :key="i">
                                <article class="no-elevate fill">
                                    <details>
                                        <summary class="none">
                                            <div class="row">
                                                <div class="max">
                                                    <h5 x-text="item.RaisonSociale"></h5>
                                                </div>
                                                <i>arrow_drop_down</i>
                                            </div>
                                        </summary>
                                        <div>
                                            <br>
                                            <p>Siren <span x-text="item.NumSiren"></span></p>
                                            <p><span x-text="item.NombreTransactions"></span> transaction(s) au total
                                            </p>
                                            <h6
                                                x-text="new Intl.NumberFormat('fr-FR', { style: 'currency', currency: item.Devise }).format(item.MontantTotal)">
                                            </h6>
                                        </div>
                                    </details>
                                </article>
                            </template>
                        </div>
                        <dialog x-ref="detailsModal">
                            <div class="center-align middle-align" style="height: 200px;"
                                x-show="loadingLinkedTransactions">
                                <a class="loader"></a>
                            </div>
                            <div x-show="!loadingLinkedTransactions">
                                <h4>Détails transactions</h4>
                                <p x-if="linkedTransactions.length > 0">SIREN n° <span
                                        x-text="linkedTransactions[0]?.numSiren"></span></p>
                                <table class="border">
                                    <thead>
                                        <tr>
                                            <th>ID transaction</th>
                                            <th>N° autorisation</th>
                                            <th>Date</th>
                                            <th>Carte</th>
                                            <th>Montant</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="transaction in linkedTransactions"
                                            :key="transaction.idTransaction">
                                            <tr>
                                                <td x-text="transaction.idTransaction"></td>
                                                <td x-text="transaction.numAuthorization"></td>
                                                <td x-text="transaction.dateTransaction"></td>
                                                <td>**** <span x-text="transaction.endingFoursCardNumbers"></span></td>
                                                <td
                                                    x-text="new Intl.NumberFormat('fr-FR', { style: 'currency', currency: transaction.currency }).format(transaction.amount)">
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                            <nav class="right-align">
                                <form method="dialog">
                                    <button class="border">Fermer</button>
                                </form>
                            </nav>
                        </dialog>
                        <div x-show="selectedTab == 're'">
                            <button class="hide-print">
                                <span>Exporter les données</span>
                                <i>arrow_drop_down</i>
                                <div class="dropdown">
                                    <a @click="exportTableIn('#transactions-table', 'csv')">.csv</a>
                                    <a @click="exportTableIn('#transactions-table', 'xls')">.xls</a>
                                    <a @click="exportTableIn('#transactions-table', 'pdf')">.pdf</a>
                                </div>
                            </button>
                            <table class="border" id="transactions-table">
                                <thead>
                                    <tr>
                                        <th>
                                            <a @click="orderTableBy(transactions, 'NumSiren')"
                                                href="javascript:void(0);">
                                                Numéro Siren
                                            </a>
                                        </th>
                                        <th>
                                            <a @click="orderTableBy(transactions, 'RaisonSociale')"
                                                href="javascript:void(0);">
                                                Raison sociale
                                            </a>
                                        </th>
                                        <th>
                                            <a @click="orderTableBy(transactions, 'NumeroRemise')"
                                                href="javascript:void(0);">
                                                Numéro remise
                                            </a>
                                        </th>
                                        <th>
                                            <a @click="orderTableBy(transactions, 'DateTraitement')"
                                                href="javascript:void(0);">
                                                Date de traitement
                                            </a>
                                        </th>
                                        <th>
                                            <a @click="orderTableBy(transactions, 'NombreTransactions')"
                                                href="javascript:void(0);">
                                                Nombre de transactions
                                            </a>
                                        </th>
                                        <th>
                                            <a @click="orderTableBy(transactions, 'MontantTotal')"
                                                href="javascript:void(0);">
                                                Montant total
                                            </a>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template
                                        x-for="transaction in transactions.slice((page - 1) * rowsCount, page * rowsCount)"
                                        :key="transaction.NumeroRemise">
                                        <tr tabindex="0" role="button"
                                            @click="loadDetailsForSiren(transaction.NumSiren)"
                                            @keyup.enter="loadDetailsForSiren(transaction.NumSiren)">
                                            <td x-text="transaction.NumSiren"></td>
                                            <td x-text="transaction.RaisonSociale"></td>
                                            <td x-text="transaction.NumeroRemise"></td>
                                            <td x-text="formatDate(transaction.DateTraitement)"></td>
                                            <td x-text="transaction.NombreTransactions"></td>
                                            <!-- If montant total is negative: red text -->
                                            <td x-text="transaction.Sens + new Intl.NumberFormat('fr-FR', { style: 'currency', currency: transaction.Devise }).format(transaction.MontantTotal)"
                                                :class="transaction.Sens == '-' ? 'red-text' : ''"></td>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                            <p>
                                Page <input type="number" x-model="page" style="all: unset; width: 30px;">
                                Afficher <input type="number" x-model="rowsCount" style="all: unset; width: 30px;">
                                lignes par page
                                <span x-text="transactions.length"></span> résultat(s)
                            </p>
                        </div>
                        <div x-show="selectedTab == 'im'">
                            <button class="hide-print">
                                <span>Exporter les données</span>
                                <i>arrow_drop_down</i>
                                <div class="dropdown">
                                    <a @click="exportTableIn('#unpaids-table', 'csv')">.csv</a>
                                    <a @click="exportTableIn('#unpaids-table', 'xls')">.xls</a>
                                    <a @click="exportTableIn('#unpaids-table', 'pdf')">.pdf</a>
                                </div>
                            </button>
                            <table class="border" id="unpaids-table">
                                <thead>
                                    <tr>
                                        <th>
                                            <a @click="orderTableBy(unpaids, 'NumSiren')" href="javascript:void(0);">
                                                Numéro Siren
                                            </a>
                                        </th>
                                        <th>
                                            <a @click="orderTableBy(unpaids, 'DateVente')" href="javascript:void(0);">
                                                Date de vente
                                            </a>
                                        </th>
                                        <th>
                                            <a @click="orderTableBy(unpaids, 'DateRemise')" href="javascript:void(0);">
                                                Date de remise
                                            </a>
                                        </th>
                                        <th>
                                            <a @click="orderTableBy(unpaids, 'NumCarte')" href="javascript:void(0);">
                                                Numéro de carte
                                            </a>
                                        </th>
                                        <th>
                                            <a @click="orderTableBy(unpaids, 'Reseau')" href="javascript:void(0);">
                                                Réseau
                                            </a>
                                        </th>
                                        <th>
                                            <a @click="orderTableBy(unpaids, 'Devise')" href="javascript:void(0);">
                                                Devise
                                            </a>
                                        </th>
                                        <th>
                                            <a @click="orderTableBy(unpaids, 'Montant')" href="javascript:void(0);">
                                                Montant
                                            </a>
                                        </th>
                                        <th>
                                            <a @click="orderTableBy(unpaids, 'LibImpayé')" href="javascript:void(0);">
                                                Libellé
                                            </a>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="unpaid in unpaids.slice((page - 1) * rowsCount, page * rowsCount)"
                                        :key="unpaid.numDossierImpayé">
                                        <tr tabindex="0" role="button" @click="loadDetailsForSiren(unpaid.NumSiren)"
                                            @keyup.enter="loadDetailsForSiren(unpaid.NumSiren)">
                                            <td x-text="unpaid.NumSiren"></td>
                                            <td x-text="formatDate(unpaid.DateVente)"></td>
                                            <td x-text="formatDate(unpaid.DateRemise)"></td>
                                            <td x-text="unpaid.NumCarte"></td>
                                            <td x-text="unpaid.Reseau"></td>
                                            <td x-text="unpaid.Devise"></td>
                                            <td x-text="unpaid.Montant"></td>
                                            <td x-text="unpaid.LibImpayé"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                            <p>
                                Page <input type="number" x-model="page" style="all: unset; width: 30px;">
                                Afficher <input type="number" x-model="rowsCount" style="all: unset; width: 30px;">
                                lignes par page
                                <span x-text="unpaids.length"></span> résultat(s)
                            </p>
                        </div>
                    </div>
                </article>

                <div></div>
                <article class="no-elevate" x-show="selectedTab == 'im'">
                    <div id="highcharts-pie-unpaids"></div>
                </article>

                <article class="no-elevate" x-show="selectedTab == 're'">
                    <div id="highcharts-line-discounts"></div>
                </article>

                <article class="no-elevate" x-show="selectedTab == 'tr'">
                    <div id="highcharts-histogram-treasury"></div>
                </article>

            </div>
        </div>
    </div>

    <style>
        .main {
            padding: 20px;
            max-width: 1300px;
        }

        .flex {
            display: grid;
            grid-template-columns: 460px 1fr;
            gap: 20px;
        }

        article+article {
            margin-top: 0;
            width: 100%;
        }

        th a:focus {
            outline: 2px dashed #000;
            outline-offset: 2px;
        }

        @media print {
            .hide-print {
                display: none;
            }
        }
    </style>
</div>